const params = new URLSearchParams(window.location.search);
const code = params.get("code");

if (code) {
  fetch("https://your-ngrok-server.ngrok-free.app/exchange-code", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ code })
  })
    .then(res => res.json())
    .then(data => {
      const token = data.access_token;

      browser.runtime.sendMessage({
        type: "GITHUB_OAUTH_TOKEN",
        token: token
      }).then((response) => {
        console.log("📬 Token sent and stored:", response);
        document.body.innerHTML = `<h2>✅ Token sent to extension</h2>`;
        setTimeout(() => window.close(), 2000);
      });
    })
    .catch(err => {
      console.error("❌ Token exchange failed", err);
      document.body.innerHTML = `<h2>❌ Token exchange failed</h2>`;
    });
}
